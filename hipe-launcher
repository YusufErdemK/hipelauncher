#!/usr/bin/env python3
"""
Hipe Launcher â€” Yeniden TasarlanmÄ±ÅŸ
Temiz, tutarlÄ±, modern bir uygulama baÅŸlatÄ±cÄ±.
"""

import gi
import os
import subprocess
import configparser
import json

gi.require_version("Gtk", "3.0")
from gi.repository import Gtk, Gdk, GdkPixbuf, GLib, Pango

APP_DIRS = [
    "/usr/share/applications",
    os.path.expanduser("~/.local/share/applications"),
]

SELF_PATH = os.path.abspath(__file__)
CONFIG_FILE = os.path.expanduser("~/.config/hipe-launcher/settings.json")

TRANSLATIONS = {
    "tr": {
        "title": "Hipe",
        "search": "Uygulama ara...",
        "settings": "Ayarlar",
        "theme": "Tema",
        "light": "AÃ§Ä±k",
        "dark": "Koyu",
        "language": "Dil",
        "launch_speed": "BaÅŸlatma Modu",
        "normal": "Normal",
        "normal_desc": "Standart baÅŸlatma",
        "power": "GÃ¼Ã§",
        "power_desc": "Arka planda Ã§alÄ±ÅŸtÄ±r",
        "ultra": "Ultra",
        "ultra_desc": "Ã–ncelikli baÅŸlat",
        "close": "Tamam",
        "apps_count": "uygulama",
        "no_results": "SonuÃ§ bulunamadÄ±",
    },
    "en": {
        "title": "Hipe",
        "search": "Search applications...",
        "settings": "Settings",
        "theme": "Theme",
        "light": "Light",
        "dark": "Dark",
        "language": "Language",
        "launch_speed": "Launch Mode",
        "normal": "Normal",
        "normal_desc": "Standard launch",
        "power": "Power",
        "power_desc": "Background launch",
        "ultra": "Ultra",
        "ultra_desc": "Priority launch",
        "close": "Done",
        "apps_count": "apps",
        "no_results": "No results found",
    },
}

# â”€â”€ Renk paletleri â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

LIGHT = {
    "bg":           "#F2F4F8",
    "bg2":          "#E8EBF2",
    "surface":      "#FFFFFF",
    "surface2":     "#F7F8FC",
    "border":       "rgba(0,0,0,0.07)",
    "border_hover": "rgba(99,102,241,0.35)",
    "header_bg":    "#FFFFFF",
    "header_border":"rgba(0,0,0,0.08)",
    "accent":       "#6366F1",          # indigo
    "accent2":      "#818CF8",
    "text":         "#111827",
    "text2":        "#6B7280",
    "search_bg":    "#FFFFFF",
    "card_bg":      "#FFFFFF",
    "card_hover":   "#FAFBFF",
    "shadow":       "rgba(99,102,241,0.10)",
    "shadow2":      "rgba(0,0,0,0.06)",
    "icon_bg":      "rgba(99,102,241,0.08)",
    "radio_active": "#6366F1",
    "sep":          "rgba(0,0,0,0.08)",
    "dialog_bg":    "#FFFFFF",
}

DARK = {
    "bg":           "#0E0F14",
    "bg2":          "#13151C",
    "surface":      "#1A1D27",
    "surface2":     "#20232F",
    "border":       "rgba(255,255,255,0.07)",
    "border_hover": "rgba(129,140,248,0.40)",
    "header_bg":    "#13151C",
    "header_border":"rgba(255,255,255,0.06)",
    "accent":       "#818CF8",
    "accent2":      "#6366F1",
    "text":         "#F1F5F9",
    "text2":        "#94A3B8",
    "search_bg":    "#1A1D27",
    "card_bg":      "#1A1D27",
    "card_hover":   "#20232F",
    "shadow":       "rgba(0,0,0,0.40)",
    "shadow2":      "rgba(0,0,0,0.30)",
    "icon_bg":      "rgba(129,140,248,0.10)",
    "radio_active": "#818CF8",
    "sep":          "rgba(255,255,255,0.07)",
    "dialog_bg":    "#1A1D27",
}


def build_css(p: dict) -> str:
    """p = renk sÃ¶zlÃ¼ÄŸÃ¼ (LIGHT veya DARK)
    
    YalnÄ±zca GTK 3 CSS'de desteklenen Ã¶zellikler kullanÄ±lÄ±r:
    - text-transform: DESTEKLENMIYOR â†’ Python'da .upper() ile yapÄ±lÄ±r
    - caret-color: DESTEKLENMIYOR â†’ kaldÄ±rÄ±ldÄ±
    - focus-within: DESTEKLENMIYOR â†’ kaldÄ±rÄ±ldÄ±
    - outline: DESTEKLENMIYOR â†’ kaldÄ±rÄ±ldÄ±
    - letter-spacing: px deÄŸil 'em' bazlÄ± deÄŸer gerekir â†’ kaldÄ±rÄ±ldÄ±
    """
    return f"""
/* â”€â”€ Temel pencere â”€â”€ */
window {{
    background-color: {p['bg']};
}}

/* â”€â”€ Header â”€â”€ */
headerbar {{
    background-color: {p['header_bg']};
    border-bottom: 1px solid {p['header_border']};
    box-shadow: 0 1px 0 {p['header_border']};
    min-height: 56px;
    padding: 0 16px;
}}
headerbar .title {{
    color: {p['text']};
    font-size: 15px;
    font-weight: 700;
}}
headerbar .subtitle {{
    color: {p['text2']};
    font-size: 11px;
    font-weight: 500;
}}
headerbar .settings-btn {{
    background-color: transparent;
    border: 1px solid {p['border']};
    border-radius: 8px;
    padding: 6px 8px;
    min-height: 32px;
    min-width: 32px;
    color: {p['text2']};
}}
headerbar .settings-btn:hover {{
    background-color: {p['icon_bg']};
    border-color: {p['border_hover']};
    color: {p['accent']};
}}
headerbar .settings-btn:active {{
    background-color: {p['surface2']};
}}

/* â”€â”€ Arama kutusu â”€â”€ */
.search-wrap {{
    background-color: {p['search_bg']};
    border: 1px solid {p['border']};
    border-radius: 14px;
    box-shadow: 0 2px 8px {p['shadow2']};
}}
.search-wrap:focus {{
    border-color: {p['accent']};
}}
.search-icon-lbl {{
    color: {p['text2']};
    font-size: 17px;
    padding: 0 6px 0 16px;
}}
.search-entry {{
    background-color: transparent;
    border: none;
    box-shadow: none;
    color: {p['text']};
    font-size: 14px;
    font-weight: 400;
    padding: 13px 16px 13px 4px;
}}
.search-entry:focus {{
    background-color: transparent;
    border: none;
    box-shadow: none;
}}

/* â”€â”€ FlowBoxChild sÄ±fÄ±rlama â€” GTK otomatik padding ekler â”€â”€ */
flowboxchild {{
    padding: 0;
    border-radius: 16px;
    background-color: transparent;
}}
flowboxchild:focus {{
    outline-color: transparent;
    box-shadow: none;
    border: none;
}}
flowboxchild:selected {{
    background-color: transparent;
}}

/* â”€â”€ Kart â”€â”€ */
.card {{
    background-color: {p['card_bg']};
    border: 1px solid {p['border']};
    border-radius: 16px;
    padding: 18px 14px 16px;
    box-shadow: 0 2px 6px {p['shadow2']};
}}
.card:hover {{
    background-color: {p['card_hover']};
    border-color: {p['border_hover']};
    box-shadow: 0 6px 20px {p['shadow']}, 0 2px 8px {p['shadow2']};
}}
.card:active {{
    background-color: {p['surface2']};
    box-shadow: 0 1px 3px {p['shadow2']};
}}

/* â”€â”€ Ä°kon arka planÄ± â”€â”€ */
.icon-wrap {{
    background-color: {p['icon_bg']};
    border-radius: 14px;
    padding: 10px;
}}

/* â”€â”€ Uygulama etiketi â”€â”€ */
.app-label {{
    color: {p['text']};
    font-size: 12px;
    font-weight: 600;
}}

/* â”€â”€ KaydÄ±rma â”€â”€ */
scrolledwindow {{
    background-color: transparent;
}}
viewport {{
    background-color: transparent;
}}
scrollbar {{
    background-color: transparent;
    border: none;
    min-width: 6px;
}}
scrollbar slider {{
    background-color: {p['border']};
    border-radius: 3px;
    min-width: 6px;
    min-height: 40px;
}}
scrollbar slider:hover {{
    background-color: {p['text2']};
}}

/* â”€â”€ Ayarlar dialog â”€â”€ */
.settings-dialog {{
    background-color: {p['dialog_bg']};
}}
.settings-header {{
    color: {p['text']};
    font-size: 16px;
    font-weight: 700;
}}
.section-title {{
    color: {p['text2']};
    font-size: 10px;
    font-weight: 700;
}}
.settings-card {{
    background-color: {p['surface']};
    border: 1px solid {p['border']};
    border-radius: 12px;
    padding: 4px 0;
}}
radiobutton {{
    color: {p['text']};
    font-size: 13px;
    font-weight: 500;
    padding: 10px 14px;
    border-radius: 8px;
}}
radiobutton:hover {{
    background-color: {p['icon_bg']};
}}
radiobutton radio {{
    background-color: {p['surface2']};
    border-color: {p['border']};
    min-width: 16px;
    min-height: 16px;
}}
radiobutton:checked radio {{
    background-color: {p['accent']};
    border-color: {p['accent']};
}}
separator {{
    background-color: {p['sep']};
    min-height: 1px;
    margin: 0 14px;
}}

/* â”€â”€ Birincil dÃ¼ÄŸme â”€â”€ */
.primary-btn {{
    background-color: {p['accent']};
    color: white;
    border: none;
    border-radius: 10px;
    padding: 10px 24px;
    font-size: 13px;
    font-weight: 600;
    box-shadow: 0 2px 8px {p['shadow']};
}}
.primary-btn:hover {{
    background-color: {p['accent2']};
    box-shadow: 0 4px 12px {p['shadow']};
}}
.primary-btn:active {{
    box-shadow: 0 1px 4px {p['shadow']};
}}

/* â”€â”€ BoÅŸ durum â”€â”€ */
.empty-icon {{
    font-size: 40px;
    color: {p['text2']};
    opacity: 0.4;
}}
.empty-label {{
    color: {p['text2']};
    font-size: 14px;
    font-weight: 500;
    opacity: 0.7;
}}
"""


class HipeLauncher(Gtk.Window):
    def __init__(self):
        super().__init__(title="Hipe Launcher")
        self.set_default_size(1280, 820)
        self.set_position(Gtk.WindowPosition.CENTER)

        self._css_provider = Gtk.CssProvider()
        Gtk.StyleContext.add_provider_for_screen(
            Gdk.Screen.get_default(),
            self._css_provider,
            Gtk.STYLE_PROVIDER_PRIORITY_APPLICATION,
        )

        self.load_settings()
        self.apps = self.load_apps()

        self.build_ui()
        self.apply_css()
        self.render_apps(self.apps)

    # â”€â”€ Ayarlar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    def load_settings(self):
        defaults = {"theme": "light", "language": "en", "launch_speed": "normal"}
        try:
            os.makedirs(os.path.dirname(CONFIG_FILE), exist_ok=True)
            if os.path.exists(CONFIG_FILE):
                with open(CONFIG_FILE) as f:
                    self.settings = {**defaults, **json.load(f)}
            else:
                self.settings = defaults
                self.save_settings()
        except Exception:
            self.settings = defaults

    def save_settings(self):
        try:
            os.makedirs(os.path.dirname(CONFIG_FILE), exist_ok=True)
            with open(CONFIG_FILE, "w") as f:
                json.dump(self.settings, f, indent=2)
        except Exception as e:
            print(f"Settings save error: {e}")

    def t(self, key):
        return TRANSLATIONS[self.settings["language"]].get(key, key)

    # â”€â”€ CSS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    def apply_css(self):
        palette = DARK if self.settings["theme"] == "dark" else LIGHT
        self._css_provider.load_from_data(build_css(palette).encode())

    # â”€â”€ ArayÃ¼z â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    def build_ui(self):
        # â”€â”€ Header bar â”€â”€
        self.header = Gtk.HeaderBar(show_close_button=True)
        self.header.set_title(self.t("title"))
        self.header.set_subtitle(f"{len(self.apps)} {self.t('apps_count')}")

        settings_btn = Gtk.Button()
        icon_img = Gtk.Image.new_from_icon_name("preferences-system-symbolic", Gtk.IconSize.MENU)
        settings_btn.set_image(icon_img)
        settings_btn.set_tooltip_text(self.t("settings"))
        settings_btn.get_style_context().add_class("settings-btn")
        settings_btn.connect("clicked", self.show_settings)
        self.header.pack_end(settings_btn)
        self.set_titlebar(self.header)

        # â”€â”€ Ana container â”€â”€
        root = Gtk.Box(orientation=Gtk.Orientation.VERTICAL)
        self.add(root)

        # â”€â”€ Arama â”€â”€
        search_outer = Gtk.Box()
        search_outer.set_margin_top(28)
        search_outer.set_margin_bottom(20)
        search_outer.set_margin_start(40)
        search_outer.set_margin_end(40)

        search_wrap = Gtk.EventBox()
        search_wrap.get_style_context().add_class("search-wrap")

        search_inner = Gtk.Box(spacing=0)

        search_icon = Gtk.Label(label="ðŸ”")
        search_icon.get_style_context().add_class("search-icon-lbl")

        self.search_entry = Gtk.Entry()
        self.search_entry.set_placeholder_text(self.t("search"))
        self.search_entry.get_style_context().add_class("search-entry")
        self.search_entry.connect("changed", self.on_search)
        self.search_entry.set_hexpand(True)

        search_inner.pack_start(search_icon, False, False, 0)
        search_inner.pack_start(self.search_entry, True, True, 0)
        search_wrap.add(search_inner)
        search_wrap.set_hexpand(True)

        search_outer.pack_start(search_wrap, True, True, 0)
        root.pack_start(search_outer, False, False, 0)

        # â”€â”€ KaydÄ±rmalÄ± alan â”€â”€
        scroll = Gtk.ScrolledWindow()
        scroll.set_policy(Gtk.PolicyType.NEVER, Gtk.PolicyType.AUTOMATIC)
        root.pack_start(scroll, True, True, 0)

        self.flow_outer = Gtk.Box(orientation=Gtk.Orientation.VERTICAL)
        self.flow_outer.set_margin_start(36)
        self.flow_outer.set_margin_end(36)
        self.flow_outer.set_margin_top(4)
        self.flow_outer.set_margin_bottom(36)

        self.flow = Gtk.FlowBox()
        self.flow.set_max_children_per_line(8)
        self.flow.set_min_children_per_line(2)
        self.flow.set_column_spacing(16)
        self.flow.set_row_spacing(16)
        self.flow.set_homogeneous(False)
        self.flow.set_selection_mode(Gtk.SelectionMode.NONE)
        self.flow.set_halign(Gtk.Align.START)

        self.flow_outer.pack_start(self.flow, False, False, 0)
        scroll.add(self.flow_outer)

    # â”€â”€ Uygulama kartlarÄ± â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    def load_apps(self):
        apps = []
        for base in APP_DIRS:
            if not os.path.isdir(base):
                continue
            for fn in os.listdir(base):
                if not fn.endswith(".desktop"):
                    continue
                path = os.path.join(base, fn)
                cfg = configparser.ConfigParser(interpolation=None)
                try:
                    cfg.read(path)
                    entry = cfg["Desktop Entry"]
                    if entry.get("NoDisplay", "false").lower() == "true":
                        continue
                    name = entry.get("Name", "").strip()
                    exec_cmd = entry.get("Exec", "").split("%")[0].strip()
                    icon = entry.get("Icon", "").strip()
                    if not name or not exec_cmd:
                        continue
                    if SELF_PATH in exec_cmd:
                        continue
                    apps.append((name, exec_cmd, icon))
                except Exception:
                    continue
        # TekrarlarÄ± kaldÄ±r, ada gÃ¶re sÄ±rala
        seen = set()
        unique = []
        for a in sorted(apps, key=lambda x: x[0].lower()):
            if a[0].lower() not in seen:
                seen.add(a[0].lower())
                unique.append(a)
        return unique

    def render_apps(self, apps):
        for child in self.flow.get_children():
            self.flow.remove(child)

        # Eski boÅŸ durum widget'larÄ±nÄ± temizle
        for child in self.flow_outer.get_children():
            if child != self.flow:
                self.flow_outer.remove(child)

        if not apps:
            empty_box = Gtk.Box(orientation=Gtk.Orientation.VERTICAL, spacing=12)
            empty_box.set_halign(Gtk.Align.CENTER)
            empty_box.set_margin_top(80)

            empty_icon = Gtk.Label(label="ðŸ”")
            empty_icon.get_style_context().add_class("empty-icon")

            empty_lbl = Gtk.Label(label=self.t("no_results"))
            empty_lbl.get_style_context().add_class("empty-label")

            empty_box.pack_start(empty_icon, False, False, 0)
            empty_box.pack_start(empty_lbl, False, False, 0)
            self.flow_outer.pack_start(empty_box, False, False, 0)
            empty_box.show_all()
        else:
            for name, cmd, icon in apps:
                self.flow.add(self.make_card(name, cmd, icon))

        self.flow.show_all()

    def make_card(self, name: str, cmd: str, icon_name: str) -> Gtk.EventBox:
        card = Gtk.EventBox()
        card.get_style_context().add_class("card")
        card.set_size_request(148, 152)

        vbox = Gtk.Box(orientation=Gtk.Orientation.VERTICAL, spacing=10)
        vbox.set_halign(Gtk.Align.CENTER)
        vbox.set_valign(Gtk.Align.CENTER)
        vbox.set_margin_top(4)
        vbox.set_margin_bottom(4)

        # Ä°kon â€” EventBox CSS padding/border-radius iÃ§in ÅŸart
        icon_widget = self.load_icon(icon_name, size=48)
        icon_eb = Gtk.EventBox()
        icon_eb.get_style_context().add_class("icon-wrap")
        icon_eb.set_halign(Gtk.Align.CENTER)
        icon_eb.add(icon_widget)
        vbox.pack_start(icon_eb, False, False, 0)

        # Etiket
        label = Gtk.Label(label=name)
        label.get_style_context().add_class("app-label")
        label.set_line_wrap(True)
        label.set_line_wrap_mode(Pango.WrapMode.WORD_CHAR)
        label.set_max_width_chars(13)
        label.set_lines(2)
        label.set_ellipsize(Pango.EllipsizeMode.END)
        label.set_justify(Gtk.Justification.CENTER)
        label.set_halign(Gtk.Align.CENTER)
        vbox.pack_start(label, False, False, 0)

        card.add(vbox)
        card.connect("button-press-event", self.on_card_click, cmd)
        card.add_events(Gdk.EventMask.ENTER_NOTIFY_MASK | Gdk.EventMask.LEAVE_NOTIFY_MASK)

        return card

    def on_card_click(self, widget, event, cmd):
        if event.button == 1:  # Sol tÄ±k
            self.launch(cmd)

    def load_icon(self, name: str, size: int = 52) -> Gtk.Image:
        try:
            if name and os.path.isfile(name):
                pix = GdkPixbuf.Pixbuf.new_from_file_at_scale(name, size, size, True)
                return Gtk.Image.new_from_pixbuf(pix)
            if name:
                theme = Gtk.IconTheme.get_default()
                if theme.has_icon(name):
                    img = Gtk.Image.new_from_icon_name(name, Gtk.IconSize.DIALOG)
                    img.set_pixel_size(size)
                    return img
        except Exception:
            pass
        fallback = Gtk.Image.new_from_icon_name("application-x-executable", Gtk.IconSize.DIALOG)
        fallback.set_pixel_size(size)
        return fallback

    # â”€â”€ Ayarlar dialog â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    def show_settings(self, _btn):
        dlg = Gtk.Dialog()
        dlg.set_title(self.t("settings"))
        dlg.set_transient_for(self)
        dlg.set_modal(True)
        dlg.set_default_size(400, 0)
        dlg.set_resizable(False)
        dlg.get_style_context().add_class("settings-dialog")

        # VarsayÄ±lan alt dÃ¼ÄŸme Ã§ubuÄŸunu gizle
        dlg.get_action_area().hide()

        content = dlg.get_content_area()
        content.set_spacing(0)

        main_box = Gtk.Box(orientation=Gtk.Orientation.VERTICAL, spacing=20)
        main_box.set_margin_top(24)
        main_box.set_margin_bottom(24)
        main_box.set_margin_start(24)
        main_box.set_margin_end(24)
        content.pack_start(main_box, False, False, 0)

        # BaÅŸlÄ±k
        header_box = Gtk.Box(orientation=Gtk.Orientation.HORIZONTAL)
        header_lbl = Gtk.Label(label=self.t("settings"))
        header_lbl.get_style_context().add_class("settings-header")
        header_lbl.set_halign(Gtk.Align.START)
        header_box.pack_start(header_lbl, True, True, 0)
        main_box.pack_start(header_box, False, False, 0)

        # â”€â”€ Tema â”€â”€
        self._add_section(main_box, self.t("theme"),
            [
                (self.t("light"), "light"),
                (self.t("dark"), "dark"),
            ],
            self.settings["theme"],
            self.on_theme_changed,
            horizontal=True,
        )

        # â”€â”€ Dil â”€â”€
        self._add_section(main_box, self.t("language"),
            [("TÃ¼rkÃ§e", "tr"), ("English", "en")],
            self.settings["language"],
            self.on_language_changed,
            horizontal=True,
        )

        # â”€â”€ BaÅŸlatma hÄ±zÄ± â”€â”€
        self._add_section(main_box, self.t("launch_speed"),
            [
                (self.t("normal"),  "normal"),
                (self.t("power"),   "power"),
                (self.t("ultra"),   "ultra"),
            ],
            self.settings["launch_speed"],
            self.on_speed_changed,
            horizontal=True,
        )

        # â”€â”€ Kapat dÃ¼ÄŸmesi â”€â”€
        close_btn = Gtk.Button(label=self.t("close"))
        close_btn.get_style_context().add_class("primary-btn")
        close_btn.set_halign(Gtk.Align.END)
        close_btn.connect("clicked", lambda *_: dlg.destroy())
        main_box.pack_start(close_btn, False, False, 0)

        dlg.show_all()

    def _add_section(self, parent, title, options, current, callback, horizontal=True):
        """Genel ayar bÃ¶lÃ¼mÃ¼ oluÅŸturucu"""
        section = Gtk.Box(orientation=Gtk.Orientation.VERTICAL, spacing=8)

        lbl = Gtk.Label(label=title.upper())
        lbl.get_style_context().add_class("section-title")
        lbl.set_halign(Gtk.Align.START)
        section.pack_start(lbl, False, False, 0)

        # EventBox: CSS border-radius ve border iÃ§in gerekli
        card_eb = Gtk.EventBox()
        card_eb.get_style_context().add_class("settings-card")

        card_inner = Gtk.Box(orientation=Gtk.Orientation.VERTICAL)

        orient = Gtk.Orientation.HORIZONTAL if horizontal else Gtk.Orientation.VERTICAL
        btn_box = Gtk.Box(orientation=orient, spacing=0)
        btn_box.set_margin_start(4)
        btn_box.set_margin_end(4)
        btn_box.set_margin_top(4)
        btn_box.set_margin_bottom(4)

        first_btn = None
        for i, (label_text, value) in enumerate(options):
            if i == 0:
                radio = Gtk.RadioButton.new_with_label_from_widget(None, label_text)
                first_btn = radio
            else:
                radio = Gtk.RadioButton.new_with_label_from_widget(first_btn, label_text)

            if value == current:
                radio.set_active(True)

            radio.connect("toggled", callback, value)
            btn_box.pack_start(radio, False, False, 0)

        card_inner.pack_start(btn_box, False, False, 0)
        card_eb.add(card_inner)
        section.pack_start(card_eb, False, False, 0)
        parent.pack_start(section, False, False, 0)

    # â”€â”€ Ayar deÄŸiÅŸtirme callback'leri â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    def on_theme_changed(self, btn, value):
        if btn.get_active():
            self.settings["theme"] = value
            self.save_settings()
            self.apply_css()

    def on_language_changed(self, btn, value):
        if btn.get_active():
            self.settings["language"] = value
            self.save_settings()
            GLib.timeout_add(80, self._rebuild_ui)

    def on_speed_changed(self, btn, value):
        if btn.get_active():
            self.settings["launch_speed"] = value
            self.save_settings()

    def _rebuild_ui(self):
        """Dil deÄŸiÅŸikliÄŸinde UI'Ä± sÄ±fÄ±rla"""
        for child in self.get_children():
            self.remove(child)
        self.build_ui()
        self.apply_css()
        self.render_apps(self.apps)
        self.show_all()
        # Header gÃ¼ncellemesi
        self.header.set_title(self.t("title"))
        self.header.set_subtitle(f"{len(self.apps)} {self.t('apps_count')}")
        return False  # GLib.timeout_add bir kez Ã§alÄ±ÅŸsÄ±n

    # â”€â”€ Arama â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    def on_search(self, entry):
        text = entry.get_text().strip().lower()
        if not text:
            self.render_apps(self.apps)
        else:
            filtered = [a for a in self.apps if text in a[0].lower()]
            self.render_apps(filtered)

    # â”€â”€ Uygulama baÅŸlatma â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    def launch(self, cmd: str):
        speed = self.settings["launch_speed"]
        try:
            if speed == "normal":
                subprocess.Popen(
                    cmd, shell=True,
                    stdout=subprocess.DEVNULL, stderr=subprocess.DEVNULL,
                    start_new_session=True,
                )
            elif speed == "power":
                subprocess.Popen(
                    f"nohup {cmd} >/dev/null 2>&1 &", shell=True,
                    stdout=subprocess.DEVNULL, stderr=subprocess.DEVNULL,
                    start_new_session=True,
                )
            else:  # ultra â€” Ã¶nce systemd-run dene, olmazsa nice ile baÅŸlat
                has_systemd = subprocess.run(
                    ["which", "systemd-run"], capture_output=True
                ).returncode == 0

                if has_systemd:
                    # --scope yerine --service: terminal gerektirmez
                    # --collect: bitiÅŸ sonrasÄ± unit otomatik temizlenir
                    ultra_cmd = (
                        f"systemd-run --user --collect "
                        f"--property=Nice=-5 "
                        f"--property=StandardOutput=null "
                        f"--property=StandardError=null "
                        f"-- {cmd}"
                    )
                    subprocess.Popen(
                        ultra_cmd, shell=True,
                        stdout=subprocess.DEVNULL, stderr=subprocess.DEVNULL,
                        start_new_session=True,
                    )
                else:
                    # systemd yoksa nice ile Ã¶ncelik ver
                    subprocess.Popen(
                        f"nice -n -5 {cmd}", shell=True,
                        stdout=subprocess.DEVNULL, stderr=subprocess.DEVNULL,
                        start_new_session=True,
                    )
            self.destroy()
        except Exception as e:
            print(f"Launch error: {e}")


if __name__ == "__main__":
    win = HipeLauncher()
    win.connect("destroy", Gtk.main_quit)
    win.show_all()
    Gtk.main()