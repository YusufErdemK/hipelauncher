#!/usr/bin/env python3
import gi
import os
import subprocess
import configparser
import json

gi.require_version("Gtk", "3.0")
from gi.repository import Gtk, Gdk, GdkPixbuf, GLib

APP_DIRS = [
    "/usr/share/applications",
    os.path.expanduser("~/.local/share/applications"),
]

SELF_PATH = os.path.abspath(__file__)
CONFIG_FILE = os.path.expanduser("~/.config/hipe-launcher/settings.json")

# Translations
TRANSLATIONS = {
    "tr": {
        "title": "Hipe BaÅŸlatÄ±cÄ±",
        "search": "Uygulama ara...",
        "settings": "Ayarlar",
        "theme": "Tema",
        "light": "AÃ§Ä±k",
        "dark": "Koyu",
        "language": "Dil",
        "launch_speed": "BaÅŸlatma HÄ±zÄ±",
        "normal": "Normal HÄ±z (Standart)",
        "power": "GÃ¼Ã§ (Arka Planda Ã‡alÄ±ÅŸtÄ±r)",
        "ultra": "Ultra HÄ±z (Ã–ncelikli BaÅŸlat)",
        "close": "Kapat",
        "apps_count": "uygulama"
    },
    "en": {
        "title": "Hipe Launcher",
        "search": "Search applications...",
        "settings": "Settings",
        "theme": "Theme",
        "light": "Light",
        "dark": "Dark",
        "language": "Language",
        "launch_speed": "Launch Speed",
        "normal": "Normal Speed (Standard)",
        "power": "Power (Background Launch)",
        "ultra": "Ultra Speed (Priority Launch)",
        "close": "Close",
        "apps_count": "applications"
    }
}


class HipeLauncher(Gtk.Window):
    def __init__(self):
        super().__init__(title="Hipe Launcher")
        self.set_default_size(1400, 900)
        self.set_position(Gtk.WindowPosition.CENTER)
        
        # Load settings
        self.load_settings()
        
        self.build_ui()
        self.apply_css()
        
        self.apps = self.load_apps()
        self.render_apps(self.apps)

    # ---------------- SETTINGS ----------------

    def load_settings(self):
        """Load settings from config file"""
        default_settings = {
            "theme": "light",
            "language": "tr",
            "launch_speed": "normal"
        }
        
        try:
            os.makedirs(os.path.dirname(CONFIG_FILE), exist_ok=True)
            if os.path.exists(CONFIG_FILE):
                with open(CONFIG_FILE, 'r') as f:
                    self.settings = {**default_settings, **json.load(f)}
            else:
                self.settings = default_settings
                self.save_settings()
        except Exception:
            self.settings = default_settings

    def save_settings(self):
        """Save settings to config file"""
        try:
            os.makedirs(os.path.dirname(CONFIG_FILE), exist_ok=True)
            with open(CONFIG_FILE, 'w') as f:
                json.dump(self.settings, f, indent=2)
        except Exception as e:
            print(f"Error saving settings: {e}")

    def get_text(self, key):
        """Get translated text"""
        return TRANSLATIONS[self.settings["language"]].get(key, key)

    # ---------------- UI ----------------

    def build_ui(self):
        root = Gtk.Box(orientation=Gtk.Orientation.VERTICAL)
        self.add(root)

        # Header bar
        header = Gtk.HeaderBar(show_close_button=True)
        header.set_title(self.get_text("title"))
        header.set_subtitle(f"{len(self.load_apps())} {self.get_text('apps_count')}")
        
        # Settings button
        settings_btn = Gtk.Button()
        settings_icon = Gtk.Image.new_from_icon_name("preferences-system", Gtk.IconSize.BUTTON)
        settings_btn.set_image(settings_icon)
        settings_btn.set_tooltip_text(self.get_text("settings"))
        settings_btn.connect("clicked", self.show_settings)
        settings_btn.get_style_context().add_class("settings-btn")
        header.pack_end(settings_btn)
        
        self.set_titlebar(header)

        # Search container
        search_container = Gtk.Box(orientation=Gtk.Orientation.VERTICAL)
        search_container.set_margin_top(32)
        search_container.set_margin_bottom(24)
        search_container.set_margin_start(48)
        search_container.set_margin_end(48)

        search_box = Gtk.Box(spacing=14)
        search_box.get_style_context().add_class("search-box")

        search_icon = Gtk.Label(label="ðŸ”")
        search_icon.get_style_context().add_class("search-icon")

        self.search = Gtk.Entry()
        self.search.set_placeholder_text(self.get_text("search"))
        self.search.get_style_context().add_class("search-entry")
        self.search.connect("changed", self.on_search)

        search_box.pack_start(search_icon, False, False, 0)
        search_box.pack_start(self.search, True, True, 0)
        
        search_container.pack_start(search_box, False, False, 0)
        root.pack_start(search_container, False, False, 0)

        # Apps container
        scroll = Gtk.ScrolledWindow()
        scroll.set_policy(Gtk.PolicyType.NEVER, Gtk.PolicyType.AUTOMATIC)
        scroll.get_style_context().add_class("apps-scroll")
        root.pack_start(scroll, True, True, 0)

        # Flow box with padding
        flow_wrapper = Gtk.Box(orientation=Gtk.Orientation.VERTICAL)
        flow_wrapper.set_margin_start(40)
        flow_wrapper.set_margin_end(40)
        flow_wrapper.set_margin_top(12)
        flow_wrapper.set_margin_bottom(32)

        self.flow = Gtk.FlowBox()
        self.flow.set_max_children_per_line(6)
        self.flow.set_column_spacing(28)
        self.flow.set_row_spacing(28)
        self.flow.set_homogeneous(False)
        self.flow.set_selection_mode(Gtk.SelectionMode.NONE)

        flow_wrapper.pack_start(self.flow, True, True, 0)
        scroll.add(flow_wrapper)

    # ---------------- SETTINGS DIALOG ----------------

    def show_settings(self, button):
        """Show settings dialog"""
        dialog = Gtk.Dialog()
        dialog.set_title(self.get_text("settings"))
        dialog.set_transient_for(self)
        dialog.set_modal(True)
        dialog.set_default_size(450, 400)
        dialog.get_style_context().add_class("settings-dialog")
        
        box = dialog.get_content_area()
        box.set_spacing(24)
        box.set_margin_top(24)
        box.set_margin_bottom(24)
        box.set_margin_start(32)
        box.set_margin_end(32)

        # Theme setting
        theme_box = Gtk.Box(orientation=Gtk.Orientation.VERTICAL, spacing=12)
        theme_label = Gtk.Label(label=self.get_text("theme"))
        theme_label.set_halign(Gtk.Align.START)
        theme_label.get_style_context().add_class("settings-label")
        theme_box.pack_start(theme_label, False, False, 0)

        theme_buttons = Gtk.Box(spacing=12)
        light_btn = Gtk.RadioButton.new_with_label_from_widget(None, self.get_text("light"))
        dark_btn = Gtk.RadioButton.new_with_label_from_widget(light_btn, self.get_text("dark"))
        
        if self.settings["theme"] == "dark":
            dark_btn.set_active(True)
        
        light_btn.connect("toggled", self.on_theme_changed, "light")
        dark_btn.connect("toggled", self.on_theme_changed, "dark")
        
        theme_buttons.pack_start(light_btn, False, False, 0)
        theme_buttons.pack_start(dark_btn, False, False, 0)
        theme_box.pack_start(theme_buttons, False, False, 0)
        box.pack_start(theme_box, False, False, 0)

        # Separator
        sep1 = Gtk.Separator(orientation=Gtk.Orientation.HORIZONTAL)
        box.pack_start(sep1, False, False, 0)

        # Language setting
        lang_box = Gtk.Box(orientation=Gtk.Orientation.VERTICAL, spacing=12)
        lang_label = Gtk.Label(label=self.get_text("language"))
        lang_label.set_halign(Gtk.Align.START)
        lang_label.get_style_context().add_class("settings-label")
        lang_box.pack_start(lang_label, False, False, 0)

        lang_buttons = Gtk.Box(spacing=12)
        tr_btn = Gtk.RadioButton.new_with_label_from_widget(None, "TÃ¼rkÃ§e")
        en_btn = Gtk.RadioButton.new_with_label_from_widget(tr_btn, "English")
        
        if self.settings["language"] == "en":
            en_btn.set_active(True)
        
        tr_btn.connect("toggled", self.on_language_changed, "tr")
        en_btn.connect("toggled", self.on_language_changed, "en")
        
        lang_buttons.pack_start(tr_btn, False, False, 0)
        lang_buttons.pack_start(en_btn, False, False, 0)
        lang_box.pack_start(lang_buttons, False, False, 0)
        box.pack_start(lang_box, False, False, 0)

        # Separator
        sep2 = Gtk.Separator(orientation=Gtk.Orientation.HORIZONTAL)
        box.pack_start(sep2, False, False, 0)

        # Launch speed setting
        speed_box = Gtk.Box(orientation=Gtk.Orientation.VERTICAL, spacing=12)
        speed_label = Gtk.Label(label=self.get_text("launch_speed"))
        speed_label.set_halign(Gtk.Align.START)
        speed_label.get_style_context().add_class("settings-label")
        speed_box.pack_start(speed_label, False, False, 0)

        speed_buttons = Gtk.Box(orientation=Gtk.Orientation.VERTICAL, spacing=8)
        normal_btn = Gtk.RadioButton.new_with_label_from_widget(None, self.get_text("normal"))
        power_btn = Gtk.RadioButton.new_with_label_from_widget(normal_btn, self.get_text("power"))
        ultra_btn = Gtk.RadioButton.new_with_label_from_widget(normal_btn, self.get_text("ultra"))
        
        if self.settings["launch_speed"] == "power":
            power_btn.set_active(True)
        elif self.settings["launch_speed"] == "ultra":
            ultra_btn.set_active(True)
        
        normal_btn.connect("toggled", self.on_speed_changed, "normal")
        power_btn.connect("toggled", self.on_speed_changed, "power")
        ultra_btn.connect("toggled", self.on_speed_changed, "ultra")
        
        speed_buttons.pack_start(normal_btn, False, False, 0)
        speed_buttons.pack_start(power_btn, False, False, 0)
        speed_buttons.pack_start(ultra_btn, False, False, 0)
        speed_box.pack_start(speed_buttons, False, False, 0)
        box.pack_start(speed_box, False, False, 0)

        # Close button
        close_btn = Gtk.Button(label=self.get_text("close"))
        close_btn.get_style_context().add_class("close-btn")
        close_btn.connect("clicked", lambda w: dialog.destroy())
        box.pack_end(close_btn, False, False, 0)

        dialog.show_all()

    def on_theme_changed(self, button, theme):
        if button.get_active():
            self.settings["theme"] = theme
            self.save_settings()
            self.apply_css()

    def on_language_changed(self, button, lang):
        if button.get_active():
            self.settings["language"] = lang
            self.save_settings()
            # Reload UI with new language
            GLib.timeout_add(100, self.reload_ui)

    def on_speed_changed(self, button, speed):
        if button.get_active():
            self.settings["launch_speed"] = speed
            self.save_settings()

    def reload_ui(self):
        """Reload UI with new language"""
        for child in self.get_children():
            self.remove(child)
        self.build_ui()
        self.render_apps(self.apps)
        self.show_all()
        return False

    # ---------------- CSS ----------------

    def apply_css(self):
        theme = self.settings["theme"]
        
        if theme == "dark":
            css = """
            window {
                background: linear-gradient(to bottom, #1a1d23 0%, #0f1115 100%);
            }

            headerbar {
                background: linear-gradient(to bottom, #2d3139 0%, #25282f 100%);
                border-bottom: 1px solid rgba(255, 255, 255, 0.08);
                box-shadow: 0 2px 8px rgba(0, 0, 0, 0.4);
                color: #ffffff;
                min-height: 52px;
            }

            headerbar > label {
                color: #ffffff;
                font-weight: 600;
                font-size: 15px;
            }

            .settings-btn {
                background: transparent;
                border: 1px solid rgba(255, 255, 255, 0.1);
                border-radius: 8px;
                padding: 8px;
            }

            .settings-btn:hover {
                background: rgba(255, 255, 255, 0.08);
                border-color: rgba(255, 255, 255, 0.2);
            }

            .search-box {
                background-color: #2d3139;
                border-radius: 18px;
                padding: 14px 20px;
                box-shadow: 
                    0 4px 12px rgba(0, 0, 0, 0.3),
                    inset 0 1px 0 rgba(255, 255, 255, 0.05);
                border: 1px solid rgba(255, 255, 255, 0.1);
            }

            .search-icon {
                color: #8e8e93;
                font-size: 19px;
            }

            .search-entry {
                background: transparent;
                border: none;
                box-shadow: none;
                color: #ffffff;
                font-size: 15px;
                caret-color: #0a84ff;
            }

            .search-entry:focus {
                background: transparent;
                border: none;
                box-shadow: none;
            }

            .apps-scroll {
                background: transparent;
            }

            .card {
                background: linear-gradient(135deg, #2d3139 0%, #25282f 100%);
                border-radius: 22px;
                padding: 24px 20px;
                box-shadow: 
                    0 6px 16px rgba(0, 0, 0, 0.4),
                    0 2px 8px rgba(0, 0, 0, 0.3),
                    inset 0 1px 0 rgba(255, 255, 255, 0.08);
                border: 1px solid rgba(255, 255, 255, 0.1);
                transition: all 200ms cubic-bezier(0.4, 0, 0.2, 1);
                min-width: 140px;
                min-height: 140px;
            }

            .card:hover {
                background: linear-gradient(135deg, #363a44 0%, #2d3139 100%);
                box-shadow: 
                    0 10px 28px rgba(0, 0, 0, 0.5),
                    0 4px 16px rgba(0, 0, 0, 0.4),
                    inset 0 1px 0 rgba(255, 255, 255, 0.12);
                border-color: rgba(255, 255, 255, 0.18);
            }

            .card:active {
                box-shadow: 
                    0 2px 10px rgba(0, 0, 0, 0.4),
                    0 1px 6px rgba(0, 0, 0, 0.3);
            }

            .app-label {
                color: #ffffff;
                font-weight: 500;
                font-size: 13px;
                letter-spacing: -0.01em;
            }

            .app-icon {
                margin-bottom: 8px;
            }

            .settings-dialog {
                background: #25282f;
            }

            .settings-label {
                color: #ffffff;
                font-weight: 600;
                font-size: 14px;
            }

            radiobutton {
                color: #ffffff;
            }

            radiobutton:checked {
                color: #0a84ff;
            }

            separator {
                background: rgba(255, 255, 255, 0.1);
                min-height: 1px;
            }

            .close-btn {
                background: linear-gradient(to bottom, #0a84ff 0%, #0070f3 100%);
                color: white;
                border: none;
                border-radius: 10px;
                padding: 10px 24px;
                font-weight: 600;
            }

            .close-btn:hover {
                background: linear-gradient(to bottom, #1a94ff 0%, #1080ff 100%);
            }
            """
        else:
            css = """
            window {
                background: linear-gradient(to bottom, #f8f9fb 0%, #eef1f5 100%);
            }

            headerbar {
                background: linear-gradient(to bottom, #667eea 0%, #5a67d8 100%);
                border-bottom: 1px solid rgba(0, 0, 0, 0.1);
                box-shadow: 0 2px 12px rgba(102, 126, 234, 0.3);
                color: white;
                min-height: 52px;
            }

            headerbar > label {
                color: #ffffff;
                font-weight: 600;
                font-size: 15px;
                text-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
            }

            .settings-btn {
                background: rgba(255, 255, 255, 0.15);
                border: 1px solid rgba(255, 255, 255, 0.2);
                border-radius: 8px;
                padding: 8px;
            }

            .settings-btn:hover {
                background: rgba(255, 255, 255, 0.25);
                border-color: rgba(255, 255, 255, 0.35);
            }

            .search-box {
                background-color: #ffffff;
                border-radius: 18px;
                padding: 14px 20px;
                box-shadow: 
                    0 4px 16px rgba(0, 0, 0, 0.06),
                    0 2px 8px rgba(0, 0, 0, 0.04),
                    inset 0 1px 0 rgba(255, 255, 255, 0.9);
                border: 1px solid rgba(0, 0, 0, 0.06);
            }

            .search-icon {
                color: #86868b;
                font-size: 19px;
            }

            .search-entry {
                background: transparent;
                border: none;
                box-shadow: none;
                color: #1d1d1f;
                font-size: 15px;
                caret-color: #667eea;
            }

            .search-entry:focus {
                background: transparent;
                border: none;
                box-shadow: none;
            }

            .apps-scroll {
                background: transparent;
            }

            .card {
                background: linear-gradient(135deg, #ffffff 0%, #fefefe 100%);
                border-radius: 22px;
                padding: 24px 20px;
                box-shadow: 
                    0 6px 16px rgba(0, 0, 0, 0.08),
                    0 2px 8px rgba(0, 0, 0, 0.04),
                    inset 0 1px 0 rgba(255, 255, 255, 0.9);
                border: 1px solid rgba(0, 0, 0, 0.08);
                transition: all 200ms cubic-bezier(0.4, 0, 0.2, 1);
                min-width: 140px;
                min-height: 140px;
            }

            .card:hover {
                background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
                box-shadow: 
                    0 10px 28px rgba(102, 126, 234, 0.15),
                    0 4px 16px rgba(0, 0, 0, 0.08),
                    inset 0 1px 0 rgba(255, 255, 255, 1);
                border-color: rgba(102, 126, 234, 0.25);
            }

            .card:active {
                box-shadow: 
                    0 2px 10px rgba(0, 0, 0, 0.1),
                    0 1px 6px rgba(0, 0, 0, 0.06);
            }

            .app-label {
                color: #1d1d1f;
                font-weight: 500;
                font-size: 13px;
                letter-spacing: -0.01em;
            }

            .app-icon {
                margin-bottom: 8px;
            }

            .settings-dialog {
                background: #ffffff;
            }

            .settings-label {
                color: #1d1d1f;
                font-weight: 600;
                font-size: 14px;
            }

            radiobutton {
                color: #1d1d1f;
            }

            radiobutton:checked {
                color: #667eea;
            }

            separator {
                background: rgba(0, 0, 0, 0.1);
                min-height: 1px;
            }

            .close-btn {
                background: linear-gradient(to bottom, #667eea 0%, #5a67d8 100%);
                color: white;
                border: none;
                border-radius: 10px;
                padding: 10px 24px;
                font-weight: 600;
            }

            .close-btn:hover {
                background: linear-gradient(to bottom, #7688ee 0%, #6a77dc 100%);
            }
            """

        provider = Gtk.CssProvider()
        provider.load_from_data(css.encode())

        Gtk.StyleContext.add_provider_for_screen(
            Gdk.Screen.get_default(),
            provider,
            Gtk.STYLE_PROVIDER_PRIORITY_APPLICATION,
        )

    # ---------------- APPS ----------------

    def load_apps(self):
        apps = []

        for base in APP_DIRS:
            if not os.path.isdir(base):
                continue

            for file in os.listdir(base):
                if not file.endswith(".desktop"):
                    continue

                path = os.path.join(base, file)
                cfg = configparser.ConfigParser(interpolation=None)

                try:
                    cfg.read(path)
                    entry = cfg["Desktop Entry"]

                    if entry.get("NoDisplay", "false").lower() == "true":
                        continue

                    name = entry.get("Name")
                    exec_cmd = entry.get("Exec", "").split("%")[0].strip()
                    icon = entry.get("Icon")

                    if SELF_PATH in exec_cmd:
                        continue

                    apps.append((name, exec_cmd, icon))

                except Exception:
                    continue

        return sorted(set(apps), key=lambda x: x[0].lower())

    def render_apps(self, apps):
        for child in self.flow.get_children():
            self.flow.remove(child)

        for name, cmd, icon in apps:
            self.flow.add(self.create_card(name, cmd, icon))

        self.flow.show_all()

    def create_card(self, name, cmd, icon_name):
        card = Gtk.EventBox()
        card.get_style_context().add_class("card")

        box = Gtk.Box(orientation=Gtk.Orientation.VERTICAL, spacing=12)
        box.set_halign(Gtk.Align.CENTER)
        box.set_valign(Gtk.Align.CENTER)

        icon = self.load_icon(icon_name)
        icon.get_style_context().add_class("app-icon")
        box.pack_start(icon, False, False, 0)

        label = Gtk.Label(label=name)
        label.set_line_wrap(True)
        label.set_max_width_chars(14)
        label.set_justify(Gtk.Justification.CENTER)
        label.set_ellipsize(3)
        label.get_style_context().add_class("app-label")

        box.pack_start(label, False, False, 0)

        card.add(box)
        card.connect("button-press-event", lambda *_: self.launch(cmd))
        return card

    def load_icon(self, name):
        try:
            if name and os.path.isfile(name):
                pix = GdkPixbuf.Pixbuf.new_from_file_at_scale(name, 76, 76, True)
                return Gtk.Image.new_from_pixbuf(pix)

            img = Gtk.Image.new_from_icon_name(name, Gtk.IconSize.DIALOG)
            img.set_pixel_size(76)
            return img

        except Exception:
            fallback = Gtk.Image.new_from_icon_name(
                "application-x-executable", Gtk.IconSize.DIALOG
            )
            fallback.set_pixel_size(76)
            return fallback

    # ---------------- ACTIONS ----------------

    def launch(self, cmd):
        """Launch application with optimized settings"""
        speed = self.settings["launch_speed"]
        
        try:
            if speed == "normal":
                # Normal launch - simple and reliable
                subprocess.Popen(
                    cmd,
                    shell=True,
                    stdout=subprocess.DEVNULL,
                    stderr=subprocess.DEVNULL,
                )
                
            elif speed == "power":
                # Power mode - detach completely and run in background
                # Uses nohup to prevent hangups and runs in new process group
                power_cmd = f"nohup {cmd} >/dev/null 2>&1 &"
                subprocess.Popen(
                    power_cmd,
                    shell=True,
                    stdout=subprocess.DEVNULL,
                    stderr=subprocess.DEVNULL,
                    start_new_session=True
                )
                
            else:  # ultra
                # Ultra mode - uses systemd-run for complete isolation and priority
                # This works without root and gives better resource management
                ultra_cmd = f"systemd-run --user --scope --nice=-5 {cmd}"
                result = subprocess.run(
                    ["which", "systemd-run"],
                    capture_output=True
                )
                
                if result.returncode == 0:
                    # systemd-run available - best option
                    subprocess.Popen(
                        ultra_cmd,
                        shell=True,
                        stdout=subprocess.DEVNULL,
                        stderr=subprocess.DEVNULL,
                    )
                else:
                    # Fallback to detached background launch
                    fallback_cmd = f"nohup {cmd} >/dev/null 2>&1 &"
                    subprocess.Popen(
                        fallback_cmd,
                        shell=True,
                        stdout=subprocess.DEVNULL,
                        stderr=subprocess.DEVNULL,
                        start_new_session=True
                    )
            
            # Close launcher after successful launch
            self.destroy()
                
        except Exception as e:
            print(f"Error launching app: {e}")

    def on_search(self, entry):
        text = entry.get_text().lower()
        if not text:
            self.render_apps(self.apps)
        else:
            self.render_apps([a for a in self.apps if text in a[0].lower()])


if __name__ == "__main__":
    win = HipeLauncher()
    win.connect("destroy", Gtk.main_quit)
    win.show_all()
    Gtk.main()