#!/usr/bin/env python3
import gi
import os
import subprocess
import configparser

gi.require_version("Gtk", "3.0")
from gi.repository import Gtk, Gdk, GdkPixbuf

APP_DIRS = [
    "/usr/share/applications",
    os.path.expanduser("~/.local/share/applications"),
]

SELF_PATH = os.path.abspath(__file__)


class HipeLauncher(Gtk.Window):
    def __init__(self):
        super().__init__(title="Hipe Launcher")
        self.set_default_size(1200, 800)
        self.set_position(Gtk.WindowPosition.CENTER)

        self.build_ui()
        self.apply_css()

        self.apps = self.load_apps()
        self.render_apps(self.apps)

    # ---------------- UI ----------------

    def build_ui(self):
        root = Gtk.Box(orientation=Gtk.Orientation.VERTICAL)
        self.add(root)

        header = Gtk.HeaderBar(show_close_button=True)
        header.set_title("Hipe Launcher")
        self.set_titlebar(header)

        search_box = Gtk.Box(spacing=10)
        search_box.set_margin_top(12)
        search_box.set_margin_bottom(12)
        search_box.set_margin_start(16)
        search_box.set_margin_end(16)

        self.search = Gtk.Entry()
        self.search.set_placeholder_text("Search app‚Ä¶")
        self.search.connect("changed", self.on_search)

        search_box.pack_start(Gtk.Label("üîç"), False, False, 0)
        search_box.pack_start(self.search, False, False, 0)
        root.pack_start(search_box, False, False, 0)

        scroll = Gtk.ScrolledWindow()
        scroll.set_policy(Gtk.PolicyType.NEVER, Gtk.PolicyType.AUTOMATIC)
        root.pack_start(scroll, True, True, 0)

        self.flow = Gtk.FlowBox()
        self.flow.set_max_children_per_line(5)
        self.flow.set_column_spacing(20)
        self.flow.set_row_spacing(20)
        self.flow.set_homogeneous(True)

        scroll.add(self.flow)

    # ---------------- CSS ----------------

    def apply_css(self):
        css = """
        window {
            background-color: #ffffff;
        }

        headerbar {
            background-color: #2C3E50;
            color: white;
        }

        .card {
            background-color: #ffffff;
            border: 1px solid rgba(0,0,0,0.15);
            border-radius: 12px;
            padding: 12px;
        }

        .card:hover {
            background-color: #f5f6f7;
            border-color: rgba(0,0,0,0.35);
        }

        .app-label {
            color: #000000;
            font-weight: 500;
        }
        """

        provider = Gtk.CssProvider()
        provider.load_from_data(css.encode())

        Gtk.StyleContext.add_provider_for_screen(
            Gdk.Screen.get_default(),
            provider,
            Gtk.STYLE_PROVIDER_PRIORITY_APPLICATION,
        )

    # ---------------- APPS ----------------

    def load_apps(self):
        apps = []

        for base in APP_DIRS:
            if not os.path.isdir(base):
                continue

            for file in os.listdir(base):
                if not file.endswith(".desktop"):
                    continue

                path = os.path.join(base, file)
                cfg = configparser.ConfigParser(interpolation=None)

                try:
                    cfg.read(path)
                    entry = cfg["Desktop Entry"]

                    if entry.get("NoDisplay", "false").lower() == "true":
                        continue

                    name = entry.get("Name")
                    exec_cmd = entry.get("Exec", "").split("%")[0].strip()
                    icon = entry.get("Icon")

                    # üî• KENDƒ∞Nƒ∞ Gƒ∞ZLE
                    if SELF_PATH in exec_cmd:
                        continue

                    apps.append((name, exec_cmd, icon))

                except Exception:
                    continue

        return sorted(set(apps), key=lambda x: x[0].lower())

    def render_apps(self, apps):
        for child in self.flow.get_children():
            self.flow.remove(child)

        for name, cmd, icon in apps:
            self.flow.add(self.create_card(name, cmd, icon))

        self.flow.show_all()

    def create_card(self, name, cmd, icon_name):
        card = Gtk.EventBox()
        card.get_style_context().add_class("card")

        box = Gtk.Box(orientation=Gtk.Orientation.VERTICAL, spacing=8)
        box.set_halign(Gtk.Align.CENTER)

        icon = self.load_icon(icon_name)
        box.pack_start(icon, False, False, 0)

        label = Gtk.Label(label=name)
        label.set_line_wrap(True)
        label.set_max_width_chars(14)
        label.set_justify(Gtk.Justification.CENTER)
        label.get_style_context().add_class("app-label")

        box.pack_start(label, False, False, 0)

        card.add(box)
        card.connect("button-press-event", lambda *_: self.launch(cmd))
        return card

    def load_icon(self, name):
        try:
            if name and os.path.isfile(name):
                pix = GdkPixbuf.Pixbuf.new_from_file_at_scale(name, 64, 64, True)
                return Gtk.Image.new_from_pixbuf(pix)

            img = Gtk.Image.new_from_icon_name(name, Gtk.IconSize.DIALOG)
            img.set_pixel_size(64)
            return img

        except Exception:
            fallback = Gtk.Image.new_from_icon_name(
                "application-x-executable", Gtk.IconSize.DIALOG
            )
            fallback.set_pixel_size(64)
            return fallback

    # ---------------- ACTIONS ----------------

    def launch(self, cmd):
        subprocess.Popen(
            cmd,
            shell=True,
            stdout=subprocess.DEVNULL,
            stderr=subprocess.DEVNULL,
        )

    def on_search(self, entry):
        text = entry.get_text().lower()
        if not text:
            self.render_apps(self.apps)
        else:
            self.render_apps([a for a in self.apps if text in a[0].lower()])


if __name__ == "__main__":
    win = HipeLauncher()
    win.connect("destroy", Gtk.main_quit)
    win.show_all()
    Gtk.main()

